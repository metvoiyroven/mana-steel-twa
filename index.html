<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mana Royale Mobile</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #1e293b; --field: #334155; --elixir: #d946ef;
            --hp: #ef4444; --gold: #f59e0b; --accent: #38bdf8;
        }
        body {
            margin: 0; padding: 0; background: var(--bg);
            color: white; font-family: 'Segoe UI', sans-serif;
            overflow: hidden; display: flex; flex-direction: column; height: 100vh;
        }

        /* –®–∞–ø–∫–∞ —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏ */
        .header {
            height: 50px; display: flex; justify-content: space-between;
            align-items: center; padding: 0 15px; background: rgba(0,0,0,0.3);
            font-weight: bold; font-size: 14px;
        }

        /* –ê—Ä–µ–Ω–∞ */
        #arena {
            flex: 1; position: relative; background: var(--field);
            margin: 10px; border-radius: 15px; border: 3px solid #475569;
            overflow: hidden;
        }

        .tower {
            position: absolute; width: 60px; height: 60px;
            background: #64748b; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 3px solid white; z-index: 5;
        }
        .tower.enemy { top: 20px; left: calc(50% - 30px); border-color: var(--hp); }
        .tower.player { bottom: 20px; left: calc(50% - 30px); border-color: var(--accent); }

        .hp-bar {
            width: 50px; height: 6px; background: #222;
            border-radius: 3px; position: absolute; top: -12px;
        }
        .hp-fill { height: 100%; background: #22c55e; width: 100%; transition: 0.3s; }

        /* –Æ–Ω–∏—Ç—ã */
        .unit {
            position: absolute; width: 34px; height: 34px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; z-index: 10; transition: transform 0.2s linear;
        }

        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls {
            height: 180px; background: #0f172a; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
        }

        .elixir-container {
            width: 90%; height: 18px; background: #334155;
            border-radius: 9px; position: relative; overflow: hidden; margin-bottom: 10px;
        }
        #elixir-fill { height: 100%; background: var(--elixir); width: 0%; transition: 0.3s linear; }
        
        .hand { display: flex; gap: 8px; justify-content: center; }
        .card {
            width: 75px; height: 100px; background: #475569; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; border: 2px solid transparent;
        }
        .card.active { border-color: var(--accent); transform: translateY(-5px); }
        .card.disabled { opacity: 0.5; filter: grayscale(1); }
        .card .cost {
            position: absolute; top: -5px; left: -5px; background: var(--elixir);
            width: 22px; height: 22px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 12px; font-weight: bold;
        }
        .card .icon { font-size: 32px; margin-bottom: 5px; }
        .card .name { font-size: 10px; text-transform: uppercase; font-weight: bold; }

    </style>
</head>
<body>

    <div class="header">
        <div id="p-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div style="color:var(--gold)">üí∞ <span id="p-gold">0</span></div>
        <div style="color:var(--accent)">–£–†. <span id="p-lvl">1</span></div>
    </div>

    <div id="arena">
        <div class="tower enemy" id="enemy-tower">
            <div class="hp-bar"><div class="hp-fill" id="enemy-hp"></div></div>
            üè∞
        </div>
        
        <div class="tower player" id="player-tower">
            <div class="hp-bar"><div class="hp-fill" id="player-hp"></div></div>
            üëë
        </div>
    </div>

    <div class="controls">
        <div class="elixir-container">
            <div id="elixir-fill"></div>
        </div>
        
        <div class="hand">
            <div class="card" onclick="playCard('knight', 3)">
                <div class="cost">3</div>
                <div class="icon">‚öîÔ∏è</div>
                <div class="name">–†—ã—Ü–∞—Ä—å</div>
            </div>
            <div class="card" onclick="playCard('archer', 2)">
                <div class="cost">2</div>
                <div class="icon">üèπ</div>
                <div class="name">–õ—É—á–Ω–∏–∫</div>
            </div>
            <div class="card" onclick="playCard('giant', 5)">
                <div class="cost">5</div>
                <div class="icon">üõ°Ô∏è</div>
                <div class="name">–ì–∏–≥–∞–Ω—Ç</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCyZxBg-j_XKkvaqoKxi62uFY73kDkVWk4",
            projectId: "manasteel-bf5f7",
            appId: "1:120074826718:web:9b289a1d28aceda479634f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        let player = { name: "–ò–≥—Ä–æ–∫", gold: 0, level: 1 };
        const uid = String(tg.initDataUnsafe.user?.id || "tester");

        // –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞
        let elixir = 0;
        let enemyHP = 1000;
        let units = [];

        async function init() {
            const snap = await getDoc(doc(db, "players", uid));
            if (snap.exists()) player = snap.data();
            else await setDoc(doc(db, "players", uid), player);
            
            updateUI();
            gameLoop();
        }

        function updateUI() {
            document.getElementById('p-name').innerText = player.name;
            document.getElementById('p-gold').innerText = player.gold;
            document.getElementById('p-lvl').innerText = player.level;
        }

        // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            setInterval(() => {
                // –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —ç–ª–∏–∫—Å–∏—Ä–∞
                if (elixir < 10) {
                    elixir += 0.05;
                    document.getElementById('elixir-fill').style.width = (elixir * 10) + "%";
                }

                // –õ–æ–≥–∏–∫–∞ –∫–∞—Ä—Ç
                document.querySelectorAll('.card').forEach(card => {
                    const cost = parseInt(card.querySelector('.cost').innerText);
                    if (elixir < cost) card.classList.add('disabled');
                    else card.classList.remove('disabled');
                });

                // –î–≤–∏–∂–µ–Ω–∏–µ —é–Ω–∏—Ç–æ–≤
                units.forEach((unit, index) => {
                    if (unit.y > 60) { // –ï—Å–ª–∏ –µ—â–µ –Ω–µ –¥–æ—à–µ–ª –¥–æ –±–∞—à–Ω–∏ –≤—Ä–∞–≥–∞
                        unit.y -= unit.speed;
                        unit.el.style.top = unit.y + "px";
                    } else {
                        // –ê—Ç–∞–∫–∞ –±–∞—à–Ω–∏
                        enemyHP -= unit.dmg;
                        document.getElementById('enemy-hp').style.width = (enemyHP / 10) + "%";
                        
                        if (enemyHP <= 0) victory();
                    }
                });
            }, 50);
        }

        window.playCard = (type, cost) => {
            if (elixir < cost) return;
            elixir -= cost;
            tg.HapticFeedback.impactOccurred('medium');

            const arena = document.getElementById('arena');
            const unitEl = document.createElement('div');
            unitEl.className = 'unit';
            unitEl.style.left = "calc(50% - 17px)";
            unitEl.style.top = (arena.offsetHeight - 100) + "px";
            
            let icon = "‚öîÔ∏è";
            let speed = 2;
            let dmg = 2;

            if (type === 'archer') { icon = "üèπ"; speed = 3; dmg = 1.5; }
            if (type === 'giant') { icon = "üõ°Ô∏è"; speed = 1; dmg = 5; }

            unitEl.innerText = icon;
            arena.appendChild(unitEl);

            units.push({ el: unitEl, y: arena.offsetHeight - 100, speed, dmg });
        };

        async function victory() {
            enemyHP = 1000;
            player.gold += 100;
            player.level += 1;
            units.forEach(u => u.el.remove());
            units = [];
            
            alert("–ü–û–ë–ï–î–ê! +100 –∑–æ–ª–æ—Ç–∞");
            updateUI();
            await updateDoc(doc(db, "players", uid), player);
            document.getElementById('enemy-hp').style.width = "100%";
        }

        init();
    </script>
</body>
</html>
