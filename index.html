<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mana & Steel: Chat Update</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc;
            --accent: #38bdf8; --gold: #f59e0b; --danger: #ef4444; --success: #10b981;
        }
        .light-theme { --bg: #f1f5f9; --card-bg: #ffffff; --text: #0f172a; --accent: #0284c7; }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Inter', sans-serif; margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh; transition: 0.3s;
        }

        .nav-bar {
            display: flex; justify-content: space-around; background: var(--card-bg);
            padding: 12px 0; border-top: 1px solid rgba(255,255,255,0.1);
            position: fixed; bottom: 0; width: 100%; z-index: 100;
        }
        .nav-item { font-size: 10px; cursor: pointer; opacity: 0.6; text-align: center; flex: 1; }
        .nav-item.active { opacity: 1; color: var(--accent); font-weight: bold; }

        .screen { display: none; padding: 15px; padding-bottom: 95px; overflow-y: auto; flex: 1; }
        .screen.active { display: flex; flex-direction: column; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; }
        
        .hp-bar-bg { width: 100%; background: #334155; height: 14px; border-radius: 7px; overflow: hidden; margin: 10px 0; }
        #hp-fill { width: 100%; background: linear-gradient(90deg, #f43f5e, #fb7185); height: 100%; transition: 0.2s; }

        input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #475569; background: #0f172a; color: white; box-sizing: border-box; }
        
        /* –ß–ê–¢ –°–¢–ò–õ–ò */
        .chat-container { flex: 1; overflow-y: auto; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 12px; background: rgba(255,255,255,0.05); max-width: 85%; word-wrap: break-word; }
        .msg b { font-size: 11px; color: var(--accent); display: block; }
        .msg p { margin: 2px 0 0 0; font-size: 14px; }
        .msg.my-msg { align-self: flex-end; background: var(--accent); color: white; }
        .msg.my-msg b { color: white; opacity: 0.8; }
        
        .chat-input-area { display: flex; gap: 8px; background: var(--card-bg); padding: 10px; border-radius: 12px; }
        .chat-tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .chat-tab { padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; background: #334155; }
        .chat-tab.active { background: var(--accent); color: white; }
    </style>
</head>
<body>

    <div id="screen-battle" class="screen active">
        <div class="card" style="text-align: center;">
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--accent)">–£–†: <span id="p-lvl">1</span></span>
                <span style="color: var(--gold)">üí∞ <span id="p-gold">0</span></span>
            </div>
            <h2 id="m-name" style="margin: 15px 0 5px 0;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
            <div class="hp-bar-bg"><div id="hp-fill"></div></div>
            <div id="monster-target" onclick="doAttack()" style="font-size: 90px; margin: 20px 0; cursor: pointer; display: inline-block;">üëæ</div>
            <div id="active-weapon" style="font-size: 13px; color: var(--success);">–ö—É–ª–∞–∫–∏</div>
            <div id="bot-status" style="display: none; font-size: 12px; color: var(--accent); margin-top: 10px;">ü§ñ –ë–æ—Ç –∞—Ç–∞–∫—É–µ—Ç...</div>
        </div>
    </div>

    <div id="screen-chat" class="screen">
        <div class="chat-tabs">
            <div id="tab-global" class="chat-tab active" onclick="switchChat('global')">–ì–ª–æ–±–∞–ª—å–Ω—ã–π</div>
            <div id="tab-friends" class="chat-tab" onclick="switchChat('friends')">–î—Ä—É–∑—å—è</div>
        </div>
        <div id="chat-box" class="chat-container"></div>
        <div class="chat-input-area">
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
            <button class="btn" style="width: 60px;" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <div id="screen-inventory" class="screen">
        <h3>üéí –ú–∞–≥–∞–∑–∏–Ω & –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
        <div class="card" id="shop-list"></div>
        <div class="card" id="inventory-list"></div>
    </div>

    <div id="screen-friends" class="screen">
        <h3>üë• –î—Ä—É–∑—å—è</h3>
        <div class="card">
            <input type="text" id="friend-id-input" placeholder="ID –¥—Ä—É–≥–∞">
            <button class="btn" style="margin-top:10px" onclick="addFriend()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="card" id="friends-list"></div>
    </div>

    <div id="screen-profile" class="screen">
        <h3>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h3>
        <div class="card">
            <p>–¢–≤–æ–π ID: <span style="background:#000; padding:2px 5px;" id="my-id-display">...</span></p>
            <input type="text" id="in-name" maxlength="15">
            <button class="btn" style="margin-top:10px" onclick="updateNick()">–°–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>
        </div>
        <div class="card">
            <button class="btn" id="daily-btn" style="background: var(--gold);" onclick="claimDaily()">üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å</button>
        </div>
        <div class="card"><button class="btn" style="background:#64748b" onclick="toggleTheme()">–¢–µ–º–∞ üåó</button></div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="showScreen('battle')">‚öîÔ∏è<br>–ë–∏—Ç–≤–∞</div>
        <div class="nav-item" onclick="showScreen('chat')">üí¨<br>–ß–∞—Ç</div>
        <div class="nav-item" onclick="showScreen('inventory')">üéí<br>–ò–Ω–≤–µ–Ω—Ç.</div>
        <div class="nav-item" onclick="showScreen('friends')">üë•<br>–î—Ä—É–∑—å—è</div>
        <div class="nav-item" onclick="showScreen('profile')">üë§<br>–ì–µ—Ä–æ–π</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCyZxBg-j_XKkvaqoKxi62uFY73kDkVWk4",
            authDomain: "manasteel-bf5f7.firebaseapp.com",
            projectId: "manasteel-bf5f7",
            storageBucket: "manasteel-bf5f7.firebasestorage.app",
            messagingSenderId: "120074826718",
            appId: "1:120074826718:web:9b289a1d28aceda479634f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        const ITEMS_DB = {
            'w1': { n: '–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –º–µ—á', d: 5, p: 150 },
            'w2': { n: '–°—Ç–∞–ª—å–Ω–æ–π –º–µ—á', d: 15, p: 600 },
            'w3': { n: '–ú–µ—á –î—Ä–∞–∫–æ–Ω–∞', d: 50, p: 2500 },
            'bot': { n: 'ü§ñ –ê–≤—Ç–æ-–∫–ª–∏–∫–µ—Ä', d: 0, p: 10000 }
        };

        let p = { name: '–ì–µ—Ä–æ–π', level: 1, gold: 0, inventory: [], equipped: null, hasBot: false, lastDaily: 0, friends: [] };
        let m = { hp: 10, max: 10, lvl: 1 };
        let currentChatMode = 'global';
        const uid = String(tg.initDataUnsafe.user?.id || "dev_test");

        async function init() {
            const snap = await getDoc(doc(db, "players", uid));
            if (snap.exists()) p = { ...p, ...snap.data() };
            else await setDoc(doc(db, "players", uid), p);
            
            document.getElementById('my-id-display').innerText = uid;
            updateUI(); renderShop(); renderInventory();
            startAutoClicker();
            listenToChat();
        }

        window.showScreen = (name) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('screen-' + name).classList.add('active');
            event.currentTarget.classList.add('active');
            if(name === 'chat') scrollChat();
        };

        window.switchChat = (mode) => {
            currentChatMode = mode;
            document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + mode).classList.add('active');
            listenToChat();
        };

        function listenToChat() {
            const q = query(collection(db, "messages"), orderBy("createdAt", "desc"), limit(30));
            onSnapshot(q, (snap) => {
                const chatBox = document.getElementById('chat-box');
                let html = "";
                const msgs = [];
                snap.forEach(d => msgs.push(d.data()));
                msgs.reverse().forEach(data => {
                    // –§–∏–ª—å—Ç—Ä –¥–ª—è —á–∞—Ç–∞ –¥—Ä—É–∑–µ–π
                    if(currentChatMode === 'friends' && data.uid !== uid && !p.friends.includes(data.uid)) return;
                    
                    const isMy = data.uid === uid;
                    html += `<div class="msg ${isMy ? 'my-msg' : ''}">
                        <b>${data.sender}</b>
                        <p>${data.text}</p>
                    </div>`;
                });
                chatBox.innerHTML = html;
                scrollChat();
            });
        }

        window.sendMessage = async () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;
            input.value = "";
            await addDoc(collection(db, "messages"), {
                uid: uid,
                sender: p.name,
                text: text,
                createdAt: serverTimestamp()
            });
        };

        function scrollChat() {
            const cb = document.getElementById('chat-box');
            cb.scrollTop = cb.scrollHeight;
        }

        window.doAttack = (isAuto = false) => {
            let dmg = 2 + (p.level * 2) + (p.equipped ? ITEMS_DB[p.equipped].d : 0);
            m.hp -= dmg;
            if(!isAuto) tg.HapticFeedback.impactOccurred('light');
            if (m.hp <= 0) {
                p.gold += 10 * m.lvl;
                if (Math.random() > 0.8) p.level++;
                m.lvl++; m.max = 10 + (m.lvl * 12); m.hp = m.max;
                save();
            }
            updateUI();
        };

        window.claimDaily = async () => {
            const now = Date.now();
            if (now - p.lastDaily >= 86400000) {
                p.gold += 500; p.lastDaily = now;
                save(); updateUI();
                alert("–ë–æ–Ω—É—Å 500üí∞ –∑–∞—á–∏—Å–ª–µ–Ω!");
            } else alert("–ë–æ–Ω—É—Å –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤!");
        };

        window.addFriend = async () => {
            const fId = document.getElementById('friend-id-input').value.trim();
            if (fId === uid) return;
            const fSnap = await getDoc(doc(db, "players", fId));
            if (fSnap.exists()) {
                await updateDoc(doc(db, "players", uid), { friends: arrayUnion(fId) });
                p.friends.push(fId);
                alert("–î—Ä—É–≥ –¥–æ–±–∞–≤–ª–µ–Ω!");
            }
        };

        function save() { updateDoc(doc(db, "players", uid), p); }
        window.buyItem = (id) => {
            const item = ITEMS_DB[id];
            if (p.gold >= item.p) {
                if (id === 'bot') p.hasBot = true; 
                else p.inventory.push(id);
                p.gold -= item.p; save(); updateUI(); renderShop(); renderInventory();
            }
        };
        window.toggleEquip = (id) => { p.equipped = (p.equipped === id) ? null : id; save(); updateUI(); renderInventory(); };
        window.updateNick = () => { let n = document.getElementById('in-name').value.trim(); if(n){ p.name = n; save(); alert("–ù–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω!"); } };
        function startAutoClicker() { if(p.hasBot) setInterval(() => { if(document.getElementById('screen-battle').classList.contains('active')) doAttack(true); }, 1000); }
        function renderShop() {
            let html = ""; for (let id in ITEMS_DB) {
                const item = ITEMS_DB[id]; const owned = (id === 'bot') ? p.hasBot : p.inventory.includes(id);
                html += `<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #334155;">
                <span>${item.n}</span><button class="btn" style="width:70px;padding:5px" onclick="buyItem('${id}')" ${owned?'disabled':''}>${owned?'üõí':item.p}</button></div>`;
            } document.getElementById('shop-list').innerHTML = html;
        }
        function renderInventory() {
            let html = ""; p.inventory.forEach(id => {
                const isEq = p.equipped === id;
                html += `<div style="display:flex;justify-content:space-between;padding:10px 0;"><span>${ITEMS_DB[id].n}</span>
                <button class="btn" style="width:70px;padding:5px;background:${isEq?'#64748b':''}" onclick="toggleEquip('${id}')">${isEq?'–°–Ω—è—Ç—å':'–ù–∞–¥–µ—Ç—å'}</button></div>`;
            }); document.getElementById('inventory-list').innerHTML = html || "–ü—É—Å—Ç–æ";
        }
        function updateUI() {
            document.getElementById('p-gold').innerText = Math.floor(p.gold);
            document.getElementById('p-lvl').innerText = p.level;
            document.getElementById('m-name').innerText = `–í—Ä–∞–≥ –£—Ä. ${m.lvl}`;
            document.getElementById('hp-fill').style.width = (m.hp/m.max*100) + "%";
            document.getElementById('in-name').value = p.name;
            document.getElementById('active-weapon').innerText = p.equipped ? `üó° ${ITEMS_DB[p.equipped].n}` : "üëä –ö—É–ª–∞–∫–∏";
            if (p.hasBot) document.getElementById('bot-status').style.display = 'block';
        }
        window.toggleTheme = () => document.body.classList.toggle('light-theme');
        init();
    </script>
</body>
</html>
