<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mana & Steel: Ultimate Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc;
            --accent: #38bdf8; --gold: #f59e0b; --danger: #ef4444; --success: #10b981;
        }
        .light-theme { --bg: #f1f5f9; --card-bg: #ffffff; --text: #0f172a; --accent: #0284c7; }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Inter', sans-serif; margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh; transition: 0.3s;
            overflow: hidden;
        }

        .nav-bar {
            display: flex; justify-content: space-around; background: var(--card-bg);
            padding: 10px 0; border-top: 1px solid rgba(255,255,255,0.1);
            position: fixed; bottom: 0; width: 100%; z-index: 100;
        }
        .nav-item { font-size: 10px; cursor: pointer; opacity: 0.6; text-align: center; flex: 1; }
        .nav-item.active { opacity: 1; color: var(--accent); font-weight: bold; }

        .screen { display: none; padding: 15px; padding-bottom: 90px; overflow-y: auto; flex: 1; }
        .screen.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.4; pointer-events: none; }
        
        .hp-wrapper { width: 100%; background: #334155; height: 22px; border-radius: 11px; overflow: hidden; margin: 10px 0; position: relative; border: 1px solid #475569; }
        #hp-fill { height: 100%; background: linear-gradient(90deg, #ef4444, #f87171); width: 100%; transition: 0.2s; }
        #hp-text { position: absolute; width: 100%; text-align: center; font-size: 12px; line-height: 22px; font-weight: bold; color: white; text-shadow: 1px 1px 1px black; }

        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .offline { background: #64748b; }

        #pvp-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15, 23, 42, 0.95); z-index:1000; align-items:center; justify-content:center; flex-direction:column; }
    </style>
</head>
<body>

    <div id="pvp-modal">
        <h1 style="color:var(--danger)">PVP –ë–ò–¢–í–ê</h1>
        <div id="pvp-timer" style="font-size: 60px; font-weight: bold; color: var(--gold);">15</div>
        <div id="pvp-target" onclick="pvpClick()" style="font-size: 120px; cursor:pointer; user-select:none;">‚öîÔ∏è</div>
        <div style="font-size: 20px; margin-top:20px;">–£—Ä–æ–Ω: <span id="my-pvp-dmg" style="color:var(--accent)">0</span></div>
    </div>

    <div id="screen-battle" class="screen active">
        <div class="card" style="text-align: center;">
            <div style="display: flex; justify-content: space-between; font-weight: bold;">
                <span style="color: var(--accent)">–£–†–û–í–ï–ù–¨: <span id="p-lvl">1</span></span>
                <span style="color: var(--gold)">üí∞ <span id="p-gold">0</span></span>
            </div>
            <h3 id="m-name" style="margin: 15px 0 5px 0;">–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–∞–≥–∞...</h3>
            <div class="hp-wrapper">
                <div id="hp-fill"></div>
                <div id="hp-text">...</div>
            </div>
            <div id="monster-target" onclick="doAttack()" style="font-size: 100px; margin: 30px 0; cursor: pointer; display: inline-block; user-select:none;">üëæ</div>
            <div id="active-weapon" style="font-size: 14px; color: var(--success); font-weight: bold;">üëä –ö—É–ª–∞–∫–∏</div>
            <div id="bot-status" style="display:none; color:var(--accent); font-size:12px; margin-top:10px;">ü§ñ –ê–≤—Ç–æ-–∫–ª–∏–∫–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç...</div>
        </div>
    </div>

    <div id="screen-chat" class="screen">
        <h3>üí¨ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</h3>
        <div id="chat-box" style="height:calc(100vh - 250px); overflow-y:auto; background:rgba(0,0,0,0.2); padding:10px; border-radius:12px; margin-bottom:10px;"></div>
        <div style="display: flex; gap: 8px;">
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; padding:12px; border-radius:10px; border:none; background:var(--card-bg); color:white;">
            <button class="btn" style="width: 60px;" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <div id="screen-inventory" class="screen">
        <h3>üõí –ú–∞–≥–∞–∑–∏–Ω</h3>
        <div class="card" id="shop-list"></div>
        <h3>üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
        <div class="card" id="inventory-list">–ü—É—Å—Ç–æ...</div>
    </div>

    <div id="screen-friends" class="screen">
        <h3>üë• –î—Ä—É–∑—å—è</h3>
        <div class="card">
            <input type="text" id="friend-id-input" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä–æ–∫–∞" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:none; background:var(--bg); color:white;">
            <button class="btn" onclick="sendFriendRequest()">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>
        </div>
        <div id="pending-requests"></div>
        <div class="card" id="friends-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        
        <h3>üèÜ –¢–æ–ø 10 –ò–≥—Ä–æ–∫–æ–≤</h3>
        <div class="card" id="leaderboard-list"></div>
    </div>

    <div id="screen-profile" class="screen">
        <h3>üë§ –ü—Ä–æ—Ñ–∏–ª—å –ì–µ—Ä–æ—è</h3>
        <div class="card">
            <p style="font-size:14px; opacity:0.7;">–¢–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID (–æ—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É):</p>
            <p id="my-id-display" style="font-family: monospace; color:var(--accent); font-size:18px; font-weight:bold;"></p>
            <input type="text" id="in-name" maxlength="15" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:none; background:var(--bg); color:white;">
            <button class="btn" onclick="updateNick()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏–∫</button>
        </div>
        <div class="card">
            <button class="btn" id="daily-btn" style="background: var(--gold);" onclick="claimDaily()">üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞ (500üí∞)</button>
            <p id="daily-timer" style="font-size:12px; text-align:center; margin-top:8px; color:var(--gold);"></p>
        </div>
        <button class="btn" style="background:#64748b" onclick="toggleTheme()">üåó –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="showScreen('battle')">‚öîÔ∏è<br>–ë–∏—Ç–≤–∞</div>
        <div class="nav-item" onclick="showScreen('chat')">üí¨<br>–ß–∞—Ç</div>
        <div class="nav-item" onclick="showScreen('inventory')">üéí<br>–ò–Ω–≤–µ–Ω—Ç.</div>
        <div class="nav-item" onclick="showScreen('friends')">üë•<br>–î—Ä—É–∑—å—è</div>
        <div class="nav-item" onclick="showScreen('profile')">üë§<br>–ì–µ—Ä–æ–π</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp, arrayUnion, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCyZxBg-j_XKkvaqoKxi62uFY73kDkVWk4",
            authDomain: "manasteel-bf5f7.firebaseapp.com",
            projectId: "manasteel-bf5f7",
            storageBucket: "manasteel-bf5f7.firebasestorage.app",
            messagingSenderId: "120074826718",
            appId: "1:120074826718:web:9b289a1d28aceda479634f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        const ITEMS_DB = {
            'w1': { n: '–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –º–µ—á', d: 5, p: 150 },
            'w2': { n: '–°—Ç–∞–ª—å–Ω–æ–π –º–µ—á', d: 15, p: 600 },
            'w3': { n: '–ú–µ—á –î—Ä–∞–∫–æ–Ω–∞', d: 50, p: 2500 },
            'bot': { n: 'ü§ñ –ê–≤—Ç–æ-–∫–ª–∏–∫–µ—Ä', d: 0, p: 10000 }
        };

        let p = { name: '–ì–µ—Ä–æ–π', level: 1, gold: 0, inventory: [], equipped: null, hasBot: false, lastDaily: 0, friends: [], lastSeen: 0 };
        let m = { hp: 10, max: 10, lvl: 1 };
        let pvpDmg = 0;
        const uid = String(tg.initDataUnsafe.user?.id || "dev_test_user");

        async function init() {
            const snap = await getDoc(doc(db, "players", uid));
            if (snap.exists()) {
                p = { ...p, ...snap.data() };
            } else {
                p.name = tg.initDataUnsafe.user?.first_name || "–ì–µ—Ä–æ–π";
                await setDoc(doc(db, "players", uid), p);
            }
            
            document.getElementById('my-id-display').innerText = uid;
            updateUI();
            listenToChat();
            listenToRequests();
            if(p.hasBot) startAutoClicker();
            setInterval(heartbeat, 30000);
            heartbeat();
            checkDailyStatus();
        }

        // --- –ë–ò–¢–í–ê ---
        window.doAttack = (isAuto = false) => {
            let dmg = 2 + (p.level * 2) + (p.equipped ? ITEMS_DB[p.equipped].d : 0);
            m.hp -= dmg;
            if(!isAuto) tg.HapticFeedback.impactOccurred('light');
            
            if (m.hp <= 0) {
                p.gold += 10 * m.lvl;
                if (Math.random() > 0.8) p.level++;
                m.lvl++; m.max = 10 + (m.lvl * 15); m.hp = m.max;
                save();
            }
            updateUI();
        };

        function startAutoClicker() {
            document.getElementById('bot-status').style.display = 'block';
            setInterval(() => {
                if(document.getElementById('screen-battle').classList.contains('active')) doAttack(true);
            }, 1000);
        }

        // --- –¢–û–ü ---
        async function loadTop() {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            try {
                const q = query(collection(db, "players"), orderBy("level", "desc"), limit(10));
                const snap = await getDocs(q);
                let html = "";
                let i = 1;
                snap.forEach(d => {
                    const data = d.data();
                    html += `<div class="item-row">
                        <span>${i++}. ${data.name}</span>
                        <b style="color:var(--accent)">–£—Ä. ${data.level}</b>
                    </div>`;
                });
                list.innerHTML = html || "–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç";
            } catch (e) { list.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¢–û–ü–∞"; }
        }

        // --- –î–†–£–ó–¨–Ø & PvP ---
        window.sendFriendRequest = async () => {
            const tid = document.getElementById('friend-id-input').value.trim();
            if(!tid || tid === uid) return;
            await addDoc(collection(db, "friendRequests"), { from: uid, fromName: p.name, to: tid, status: 'pending' });
            alert("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
            document.getElementById('friend-id-input').value = "";
        };

        function listenToRequests() {
            onSnapshot(query(collection(db, "friendRequests"), where("to", "==", uid), where("status", "==", "pending")), (snap) => {
                const area = document.getElementById('pending-requests');
                area.innerHTML = "";
                snap.forEach(d => {
                    area.innerHTML += `<div class="card" style="border:1px solid var(--accent)">
                        –ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –æ—Ç <b>${d.data().fromName}</b>
                        <button class="btn" style="background:var(--success); margin-top:5px;" onclick="acceptFriend('${d.data().from}', '${d.id}')">–ü—Ä–∏–Ω—è—Ç—å</button>
                    </div>`;
                });
            });
        }

        window.acceptFriend = async (fid, rid) => {
            await updateDoc(doc(db, "players", uid), { friends: arrayUnion(fid) });
            await updateDoc(doc(db, "players", fid), { friends: arrayUnion(uid) });
            await updateDoc(doc(db, "friendRequests", rid), { status: 'accepted' });
            p.friends.push(fid);
            loadFriends();
        };

        async function loadFriends() {
            const list = document.getElementById('friends-list');
            if(p.friends.length === 0) { list.innerHTML = "–î—Ä—É–∑–µ–π –ø–æ–∫–∞ –Ω–µ—Ç"; return; }
            list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            let html = "";
            for(let fid of p.friends) {
                const f = await getDoc(doc(db, "players", fid));
                if(f.exists()) {
                    const d = f.data();
                    const isOnline = (Date.now() - (d.lastSeen || 0)) < 120000;
                    html += `<div class="item-row">
                        <span><span class="status-dot ${isOnline?'online':'offline'}"></span>${d.name} (–£—Ä. ${d.level})</span>
                        <button class="btn" style="width:60px; background:var(--danger); font-size:10px;" onclick="alert('PvP —Å–∫–æ—Ä–æ!')">PvP</button>
                    </div>`;
                }
            }
            list.innerHTML = html;
        }

        // --- –ú–ê–ì–ê–ó–ò–ù & –ò–ù–í–ï–ù–¢–ê–†–¨ ---
        function renderShop() {
            let html = "";
            for (let id in ITEMS_DB) {
                const item = ITEMS_DB[id];
                const owned = (id === 'bot') ? p.hasBot : p.inventory.includes(id);
                html += `<div class="item-row">
                    <span><b>${item.n}</b><br><small>${id === 'bot'?'–ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞':'–£—Ä–æ–Ω: +'+item.d}</small></span>
                    <button class="btn" style="width:80px" onclick="buyItem('${id}')" ${owned?'disabled':''}>${owned?'üõí':item.p}</button>
                </div>`;
            }
            document.getElementById('shop-list').innerHTML = html;
        }

        function renderInventory() {
            let html = "";
            p.inventory.forEach(id => {
                const isEq = p.equipped === id;
                html += `<div class="item-row">
                    <span>${ITEMS_DB[id].n}</span>
                    <button class="btn ${isEq?'offline':''}" style="width:80px" onclick="toggleEquip('${id}')">${isEq?'–°–Ω—è—Ç—å':'–ù–∞–¥–µ—Ç—å'}</button>
                </div>`;
            });
            document.getElementById('inventory-list').innerHTML = html || "–í –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ –ø—É—Å—Ç–æ";
        }

        window.buyItem = (id) => {
            if (p.gold >= ITEMS_DB[id].p) {
                p.gold -= ITEMS_DB[id].p;
                if (id === 'bot') { p.hasBot = true; startAutoClicker(); }
                else { p.inventory.push(id); }
                save(); updateUI(); renderShop(); renderInventory();
            }
        };

        window.toggleEquip = (id) => {
            p.equipped = (p.equipped === id) ? null : id;
            save(); updateUI(); renderInventory();
        };

        // --- –°–ò–°–¢–ï–ú–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function save() { updateDoc(doc(db, "players", uid), p); }
        function heartbeat() { p.lastSeen = Date.now(); updateDoc(doc(db, "players", uid), { lastSeen: p.lastSeen }); }
        
        window.showScreen = (name) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('screen-' + name).classList.add('active');
            const items = document.querySelectorAll('.nav-item');
            if(name === 'inventory') { renderShop(); renderInventory(); }
            if(name === 'friends') { loadFriends(); loadTop(); }
        };

        function listenToChat() {
            onSnapshot(query(collection(db, "messages"), orderBy("createdAt", "desc"), limit(25)), (snap) => {
                const box = document.getElementById('chat-box');
                box.innerHTML = "";
                let msgs = [];
                snap.forEach(d => msgs.push(d.data()));
                msgs.reverse().forEach(d => {
                    box.innerHTML += `<div style="margin-bottom:8px; font-size:14px;"><b>${d.sender}:</b> ${d.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        window.sendMessage = async () => {
            const inp = document.getElementById('msg-input');
            if(!inp.value.trim()) return;
            await addDoc(collection(db, "messages"), { sender: p.name, text: inp.value, createdAt: serverTimestamp() });
            inp.value = "";
        };

        window.claimDaily = () => {
            const now = Date.now();
            if (now - p.lastDaily >= 86400000) {
                p.gold += 500; p.lastDaily = now;
                save(); updateUI(); checkDailyStatus();
                alert("–¢—ã –ø–æ–ª—É—á–∏–ª 500 –∑–æ–ª–æ—Ç–∞!");
            }
        };

        function checkDailyStatus() {
            const btn = document.getElementById('daily-btn');
            const timer = document.getElementById('daily-timer');
            const diff = Date.now() - p.lastDaily;
            if (diff < 86400000) {
                btn.disabled = true;
                timer.innerText = "–í–µ—Ä–Ω–∏—Å—å —á–µ—Ä–µ–∑: " + Math.floor((86400000 - diff) / 3600000) + "—á.";
            } else {
                btn.disabled = false;
                timer.innerText = "–ù–∞–≥—Ä–∞–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞!";
            }
        }

        function updateUI() {
            document.getElementById('p-gold').innerText = Math.floor(p.gold);
            document.getElementById('p-lvl').innerText = p.level;
            document.getElementById('m-name').innerText = `–ú–æ–Ω—Å—Ç—Ä ${m.lvl} –£—Ä.`;
            document.getElementById('hp-fill').style.width = (m.hp/m.max*100) + "%";
            document.getElementById('hp-text').innerText = `${Math.max(0, m.hp)} / ${m.max} HP`;
            document.getElementById('in-name').value = p.name;
            document.getElementById('active-weapon').innerText = p.equipped ? `üó° ${ITEMS_DB[p.equipped].n}` : "üëä –ö—É–ª–∞–∫–∏";
        }

        window.updateNick = () => {
            p.name = document.getElementById('in-name').value.trim() || "–ì–µ—Ä–æ–π";
            save(); alert("–ù–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
        };

        window.toggleTheme = () => document.body.classList.toggle('light-theme');

        init();
    </script>
</body>
</html>
