<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mana & Steel: Battle</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: var(--tg-theme-bg-color, #1a1a1a);
            color: var(--tg-theme-text-color, #ffffff);
            font-family: sans-serif;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; margin: 0; justify-content: center;
            user-select: none;
        }
        .container {
            background: var(--tg-theme-secondary-bg-color, #242424);
            padding: 25px; border-radius: 20px; text-align: center;
            width: 80%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        /* –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è */
        .hp-container {
            width: 100%; background: #444; height: 12px;
            border-radius: 6px; margin: 15px 0; overflow: hidden;
            border: 1px solid #555;
        }
        #hp-bar {
            width: 100%; background: linear-gradient(90deg, #ff4444, #ff6666);
            height: 100%; transition: width 0.15s ease-out;
        }
        /* –ú–æ–Ω—Å—Ç—Ä */
        #monster-target {
            font-size: 100px; margin: 20px 0; cursor: pointer;
            transition: transform 0.05s; display: inline-block;
        }
        #monster-target:active { transform: scale(0.9); }
        
        .stats { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; }
        .gold { color: #ffd700; }
        .level { color: #0088cc; }
        #status { font-size: 10px; opacity: 0.5; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="stats">
            <span class="level">LVL: <span id="p-level">1</span></span>
            <span class="gold">üí∞ <span id="p-gold">0</span></span>
        </div>

        <h3 id="m-name" style="margin: 0;">–°–ª–∏–∑–µ–Ω–∏–π –£—Ä. 1</h3>
        
        <div class="hp-container">
            <div id="hp-bar"></div>
        </div>
        <div id="hp-text" style="font-size: 12px;">10 / 10 HP</div>

        <div id="monster-target" onclick="attack()">üëæ</div>

        <p style="font-size: 14px; opacity: 0.8;">–ö–ª–∏–∫–∞–π –Ω–∞ –º–æ–Ω—Å—Ç—Ä–∞!</p>
        <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –≥–µ—Ä–æ—è...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCyZxBg-j_XKkvaqoKxi62uFY73kDkVWk4",
            authDomain: "manasteel-bf5f7.firebaseapp.com",
            projectId: "manasteel-bf5f7",
            storageBucket: "manasteel-bf5f7.firebasestorage.app",
            messagingSenderId: "120074826718",
            appId: "1:120074826718:web:9b289a1d28aceda479634f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        let player = { level: 1, gold: 0, damage: 2 };
        let monster = { hp: 10, maxHp: 10, lvl: 1 };
        const userId = tg.initDataUnsafe.user?.id || "local_dev";

        async function init() {
            const ref = doc(db, "players", String(userId));
            const snap = await getDoc(ref);
            if (snap.exists()) {
                player = { ...player, ...snap.data() };
            } else {
                await setDoc(ref, player);
            }
            updateUI();
            document.getElementById('status').innerText = "–û—Ö–æ—Ç–∞ –Ω–∞—á–∞–ª–∞—Å—å";
        }

        window.attack = async () => {
            monster.hp -= player.damage + player.level;
            tg.HapticFeedback.impactOccurred('light');

            if (monster.hp <= 0) {
                // –ü–æ–±–µ–¥–∞
                tg.HapticFeedback.notificationOccurred('success');
                let reward = 10 * monster.lvl;
                player.gold += reward;
                
                // –®–∞–Ω—Å –ø–æ–¥–Ω—è—Ç—å —É—Ä–æ–≤–µ–Ω—å –∏–≥—Ä–æ–∫–∞ –ø—Ä–∏ —É–±–∏–π—Å—Ç–≤–µ
                if (Math.random() > 0.7) player.level++;

                // –°–ª–µ–¥—É—é—â–∏–π –º–æ–Ω—Å—Ç—Ä
                monster.lvl++;
                monster.maxHp = 10 + (monster.lvl * 8);
                monster.hp = monster.maxHp;
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
                const ref = doc(db, "players", String(userId));
                await updateDoc(ref, { 
                    gold: player.gold, 
                    level: player.level 
                });
            }
            updateUI();
        };

        function updateUI() {
            document.getElementById('p-gold').innerText = player.gold;
            document.getElementById('p-level').innerText = player.level;
            document.getElementById('m-name').innerText = `–ú–æ–Ω—Å—Ç—Ä –£—Ä. ${monster.lvl}`;
            
            const hpProc = (monster.hp / monster.maxHp) * 100;
            document.getElementById('hp-bar').style.width = Math.max(0, hpProc) + "%";
            document.getElementById('hp-text').innerText = `${Math.max(0, monster.hp)} / ${monster.maxHp} HP`;
        }

        init();
    </script>
</body>
</html>
