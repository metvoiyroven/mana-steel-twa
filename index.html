<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mana Royale</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #1e293b; /* –§–æ–Ω –∏–≥—Ä—ã */
            --card-bg: #2d3a4b; /* –§–æ–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ UI */
            --text: #f8fafc; /* –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
            --accent: #38bdf8; /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç (–¥–ª—è –∫–Ω–æ–ø–æ–∫, –Ω–∏–∫–∞) */
            --gold: #f59e0b; /* –ó–æ–ª–æ—Ç–æ */
            --elixir: #d946ef; /* –≠–ª–∏–∫—Å–∏—Ä */
            --player-color: #10b981; /* –¶–≤–µ—Ç –∏–≥—Ä–æ–∫–∞ (–∑–µ–ª–µ–Ω—ã–π) */
            --enemy-color: #ef4444; /* –¶–≤–µ—Ç –≤—Ä–∞–≥–∞ (–∫—Ä–∞—Å–Ω—ã–π) */
            --tower-hp-bg: #475569; /* –§–æ–Ω HP –±–∞—à–µ–Ω */
        }
        .light-theme {
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text: #0f172a;
            --accent: #0284c7;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
            user-select: none;
        }

        /* Nav Bar */
        .nav-bar {
            display: flex; justify-content: space-around;
            background: var(--card-bg);
            padding: 10px 0;
            border-top: 1px solid rgba(255,255,255,0.1);
            position: fixed; bottom: 0; width: 100%; z-index: 100;
        }
        .nav-item {
            font-size: 10px; cursor: pointer; opacity: 0.6; text-align: center; flex: 1;
            transition: opacity 0.2s, color 0.2s;
        }
        .nav-item.active { opacity: 1; color: var(--accent); font-weight: bold; }

        /* Screens */
        .screen {
            display: none; padding: 15px; padding-bottom: 90px;
            overflow-y: auto; flex: 1;
        }
        .screen.active {
            display: flex; flex-direction: column; /* –î–ª—è Arena Screen */
            animation: fadeIn 0.2s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* General Card & Button Styles */
        .card {
            background: var(--card-bg); border-radius: 16px;
            padding: 15px; margin-bottom: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .btn {
            background: var(--accent); color: white; border: none;
            padding: 10px; border-radius: 10px; font-weight: bold;
            cursor: pointer; width: 100%; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.4; pointer-events: none; }
        
        input {
            width: 100%; padding: 10px; border-radius: 8px;
            border: 1px solid #475569; background: var(--bg); color: var(--text);
            box-sizing: border-box; margin-bottom: 8px;
        }

        /* --- ARENA SPECIFIC STYLES --- */
        #arena-screen {
            flex: 1; display: flex; flex-direction: column;
            background: #334155; /* –§–æ–Ω –∞—Ä–µ–Ω—ã */
            position: relative;
            overflow: hidden; /* –í–∞–∂–Ω–æ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —é–Ω–∏—Ç–æ–≤ */
        }

        #arena-field {
            flex: 1; position: relative;
            border-bottom: 5px solid #475569; /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è */
            background: #2d3a4b; /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –ø–æ–ª—è */
        }

        .tower {
            position: absolute; width: 60px; height: 60px;
            background: #64748b; border-radius: 10px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 10px; font-weight: bold;
            color: white; text-shadow: 1px 1px 1px black;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .tower .hp-bar-outer { width: 80%; height: 5px; background: var(--tower-hp-bg); border-radius: 3px; margin-top: 2px; }
        .tower .hp-bar-inner { height: 100%; background: var(--hp); width: 100%; transition: width 0.2s; }

        #player-tower { bottom: 20px; left: calc(50% - 30px); border: 3px solid var(--player-color); }
        #enemy-tower { top: 20px; left: calc(50% - 30px); border: 3px solid var(--enemy-color); }

        .unit {
            position: absolute; width: 35px; height: 35px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
            transition: all 0.3s ease-out; /* –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ */
        }
        .unit .hp-bar { position: absolute; top: -8px; width: 25px; height: 3px; background: #333; border-radius: 2px; overflow: hidden; }
        .unit .hp-fill { height: 100%; background: var(--player-color); width: 100%; transition: width 0.1s; }

        /* UI Panel (Elixir & Cards) */
        #arena-ui-panel {
            background: var(--card-bg); padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        #elixir-bar-container {
            width: 90%; height: 25px; background: #0f172a; border-radius: 12px;
            margin-bottom: 10px; position: relative; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2);
        }
        #elixir-fill { height: 100%; background: var(--elixir); width: 0%; transition: width 0.3s ease-out; }
        #elixir-text {
            position: absolute; width: 100%; text-align: center;
            line-height: 25px; font-weight: bold; font-size: 14px;
            color: white; text-shadow: 1px 1px 1px black;
        }
        
        .hand {
            display: flex; gap: 10px; justify-content: center; width: 100%;
        }
        .card-item {
            width: 70px; height: 90px; background: #475569; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: space-around;
            font-size: 12px; cursor: pointer; border: 2px solid transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.1s, opacity 0.2s, border-color 0.2s;
        }
        .card-item:active:not(.disabled) { transform: scale(0.95); }
        .card-item.disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
        .card-item .cost { font-size: 16px; font-weight: bold; color: var(--gold); }
        .card-item .icon { font-size: 30px; line-height: 1; }

        /* Message Boxes */
        #message-box {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 15px;
            z-index: 1000; display: none; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* General List Items (for Friends, Shop, etc.) */
        .item-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background: var(--player-color); box-shadow: 0 0 5px var(--player-color); }
        .offline { background: #64748b; }
    </style>
</head>
<body>

    <div id="message-box"></div>

    <div id="screen-arena" class="screen active">
        <div id="arena-field">
            <div id="enemy-tower" class="tower">
                <div style="font-size:25px;">üè∞</div>
                <div class="hp-bar-outer"><div id="enemy-hp-fill" class="hp-bar-inner"></div></div>
                <div id="enemy-hp-text">2000</div>
            </div>
            <div id="player-tower" class="tower">
                <div style="font-size:25px;">üè∞</div>
                <div class="hp-bar-outer"><div id="player-hp-fill" class="hp-bar-inner"></div></div>
                <div id="player-hp-text">2000</div>
            </div>
        </div>
        <div id="arena-ui-panel">
            <div id="elixir-bar-container">
                <div id="elixir-fill"></div>
                <div id="elixir-text">–≠–ª–∏–∫—Å–∏—Ä: 0/10</div>
            </div>
            <div class="hand" id="card-hand">
                </div>
        </div>
    </div>

    <div id="screen-chat" class="screen">
        <h3>üí¨ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</h3>
        <div id="chat-box" style="height:calc(100vh - 250px); overflow-y:auto; background:rgba(0,0,0,0.2); padding:10px; border-radius:12px; margin-bottom:10px;"></div>
        <div style="display: flex; gap: 8px;">
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1;">
            <button class="btn" style="width: 60px;" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <div id="screen-inventory" class="screen">
        <h3>üõí –ú–∞–≥–∞–∑–∏–Ω</h3>
        <div class="card" id="shop-list"></div>
        <h3>üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
        <div class="card" id="inventory-list">–í –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ –ø—É—Å—Ç–æ</div>
    </div>

    <div id="screen-friends" class="screen">
        <h3>üë• –î—Ä—É–∑—å—è</h3>
        <div class="card">
            <input type="text" id="friend-id-input" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∏–≥—Ä–æ–∫–∞">
            <button class="btn" onclick="sendFriendRequest()">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>
        </div>
        <div id="pending-requests"></div>
        <div class="card" id="friends-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        
        <h3>üèÜ –¢–æ–ø 10 –ò–≥—Ä–æ–∫–æ–≤</h3>
        <div class="card" id="leaderboard-list"></div>
    </div>

    <div id="screen-profile" class="screen">
        <h3>üë§ –ü—Ä–æ—Ñ–∏–ª—å –ì–µ—Ä–æ—è</h3>
        <div class="card">
            <p style="font-size:14px; opacity:0.7;">–¢–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID (–æ—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É):</p>
            <p id="my-id-display" style="font-family: monospace; color:var(--accent); font-size:18px; font-weight:bold;"></p>
            <input type="text" id="in-name" maxlength="15">
            <button class="btn" onclick="updateNick()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏–∫</button>
        </div>
        <div class="card">
            <button class="btn" id="daily-btn" style="background: var(--gold);" onclick="claimDaily()">üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞ (500üí∞)</button>
            <p id="daily-timer" style="font-size:12px; text-align:center; margin-top:8px; color:var(--gold);"></p>
        </div>
        <button class="btn" style="background:#64748b" onclick="toggleTheme()">üåó –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="showScreen('arena')">‚öîÔ∏è<br>–ê—Ä–µ–Ω–∞</div>
        <div class="nav-item" onclick="showScreen('chat')">üí¨<br>–ß–∞—Ç</div>
        <div class="nav-item" onclick="showScreen('inventory')">üéí<br>–ò–Ω–≤–µ–Ω—Ç.</div>
        <div class="nav-item" onclick="showScreen('friends')">üë•<br>–î—Ä—É–∑—å—è</div>
        <div class="nav-item" onclick="showScreen('profile')">üë§<br>–ì–µ—Ä–æ–π</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp, arrayUnion, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCyZxBg-j_XKkvaqoKxi62uFY73kDkVWk4", // –¢–≤–æ–π API-–∫–ª—é—á
            authDomain: "manasteel-bf5f7.firebaseapp.com",
            projectId: "manasteel-bf5f7",
            storageBucket: "manasteel-bf5f7.appspot.com",
            messagingSenderId: "120074826718",
            appId: "1:120074826718:web:9b289a1d28aceda479634f"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- Game State & Player Data ---
        let p = { name: '–ì–µ—Ä–æ–π', level: 1, gold: 0, inventory: [], equipped: null, hasBot: false, lastDaily: 0, friends: [], lastSeen: 0 };
        const uid = String(tg.initDataUnsafe.user?.id || "dev_test_user");

        // Arena Specific
        let elixir = 0;
        let playerTowerHP = 2000;
        let enemyTowerHP = 2000;
        const UNIT_TYPES = {
            knight: { cost: 3, hp: 500, dmg: 50, speed: 1.5, icon: '‚öîÔ∏è', color: '#fbbf24' },
            archer: { cost: 2, hp: 200, dmg: 30, speed: 2, icon: 'üèπ', color: '#f87171' },
            giant: { cost: 5, hp: 1500, dmg: 40, speed: 1, icon: 'üõ°Ô∏è', color: '#fb923c' }
        };
        const activeUnits = []; // –Æ–Ω–∏—Ç—ã –Ω–∞ –ø–æ–ª–µ –±–æ—è
        let elixirInterval;
        let gameLoopInterval;

        // --- INITIALIZATION ---
        async function init() {
            const snap = await getDoc(doc(db, "players", uid));
            if (snap.exists()) {
                p = { ...p, ...snap.data() };
            } else {
                p.name = tg.initDataUnsafe.user?.first_name || "–ì–µ—Ä–æ–π";
                await setDoc(doc(db, "players", uid), p);
            }
            
            document.getElementById('my-id-display').innerText = uid;
            updateUI();
            listenToChat();
            listenToRequests();
            setInterval(heartbeat, 30000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ "–æ–Ω–ª–∞–π–Ω" —Å—Ç–∞—Ç—É—Å–∞
            heartbeat();
            checkDailyStatus();
            startArenaGame(); // –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Ä–µ–Ω—É —Å—Ä–∞–∑—É –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        }

        // --- ARENA GAME LOGIC ---
        function startArenaGame() {
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã
            elixir = 0;
            playerTowerHP = 2000;
            enemyTowerHP = 2000;
            activeUnits.length = 0; // –û—á–∏—â–∞–µ–º –º–∞—Å—Å–∏–≤ —é–Ω–∏—Ç–æ–≤
            document.getElementById('arena-field').innerHTML = `
                <div id="enemy-tower" class="tower">
                    <div style="font-size:25px;">üè∞</div>
                    <div class="hp-bar-outer"><div id="enemy-hp-fill" class="hp-bar-inner"></div></div>
                    <div id="enemy-hp-text">2000</div>
                </div>
                <div id="player-tower" class="tower">
                    <div style="font-size:25px;">üè∞</div>
                    <div class="hp-bar-outer"><div id="player-hp-fill" class="hp-bar-inner"></div></div>
                    <div id="player-hp-text">2000</div>
                </div>
            `; // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –±–∞—à–Ω–∏ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã

            if (elixirInterval) clearInterval(elixirInterval);
            if (gameLoopInterval) clearInterval(gameLoopInterval);

            elixirInterval = setInterval(gainElixir, 1000); // –≠–ª–∏–∫—Å–∏—Ä –∫–∞–∂–¥—ã–µ 1 —Å–µ–∫—É–Ω–¥—É
            gameLoopInterval = setInterval(gameLoop, 50); // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª –∫–∞–∂–¥—ã–µ 50–º—Å

            renderCardHand(); // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞—Ä—Ç—ã
            updateArenaUI(); // –û–±–Ω–æ–≤–ª—è–µ–º UI –∞—Ä–µ–Ω—ã
        }

        function gainElixir() {
            if (elixir < 10) {
                elixir = Math.min(10, elixir + 1); // +1 —ç–ª–∏–∫—Å–∏—Ä–∞ –≤ —Å–µ–∫—É–Ω–¥—É
                updateArenaUI();
            }
        }

        function renderCardHand() {
            const hand = document.getElementById('card-hand');
            hand.innerHTML = '';
            Object.keys(UNIT_TYPES).forEach(type => {
                const config = UNIT_TYPES[type];
                const cardEl = document.createElement('div');
                cardEl.className = 'card-item';
                cardEl.innerHTML = `<span class="icon">${config.icon}</span><span>${config.n || type}</span><b class="cost">${config.cost}</b>`;
                cardEl.onclick = () => spawnUnit(type);
                hand.appendChild(cardEl);
            });
            updateCardAvailability();
        }

        function updateCardAvailability() {
            document.querySelectorAll('.card-item').forEach(cardEl => {
                const type = cardEl.querySelector('span:nth-child(2)').innerText.toLowerCase(); // Assuming name is second span
                const config = UNIT_TYPES[type];
                if (elixir >= config.cost) {
                    cardEl.classList.remove('disabled');
                } else {
                    cardEl.classList.add('disabled');
                }
            });
        }

        window.spawnUnit = (type) => {
            const config = UNIT_TYPES[type];
            if (elixir >= config.cost) {
                elixir -= config.cost;
                tg.HapticFeedback.impactOccurred('light');

                const unitEl = document.createElement('div');
                unitEl.className = 'unit';
                unitEl.style.backgroundColor = config.color;
                unitEl.style.bottom = '80px'; // –°–ø–∞–≤–Ω —Å–Ω–∏–∑—É
                unitEl.style.left = `${50 + (Math.random() * 20 - 10)}%`; // –ù–µ–º–Ω–æ–≥–æ —Ä–∞–Ω–¥–æ–º–∏–∑–∏—Ä—É–µ–º X
                unitEl.innerHTML = `<div class="hp-bar"><div class="hp-fill" style="background:var(--player-color)"></div></div>${config.icon}`;
                document.getElementById('arena-field').appendChild(unitEl);
                
                const unitObj = {
                    id: Date.now() + Math.random(), // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —é–Ω–∏—Ç–∞
                    el: unitEl,
                    hp: config.hp,
                    maxHp: config.hp,
                    y: 80, // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è —Å–Ω–∏–∑—É
                    x: parseFloat(unitEl.style.left),
                    speed: config.speed,
                    dmg: config.dmg,
                    target: 'enemyTower', // –ü–æ–∫–∞ –≤—Å–µ –∞—Ç–∞–∫—É—é—Ç –≤—Ä–∞–∂–µ—Å–∫—É—é –±–∞—à–Ω—é
                    lastAttackTime: 0
                };
                activeUnits.push(unitObj);
                updateArenaUI();
            } else {
                tg.HapticFeedback.notificationOccurred('error');
            }
        };

        function gameLoop() {
            // –î–≤–∏–∂–µ–Ω–∏–µ –∏ –∞—Ç–∞–∫–∞ —é–Ω–∏—Ç–æ–≤
            activeUnits.forEach((unit, index) => {
                if (unit.hp <= 0) {
                    unit.el.remove();
                    activeUnits.splice(index, 1);
                    return;
                }

                // –î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏
                if (unit.y < 420) { // –í—ã—Å–æ—Ç–∞, –≥–¥–µ —é–Ω–∏—Ç—ã –Ω–∞—á–∏–Ω–∞—é—Ç –∞—Ç–∞–∫–æ–≤–∞—Ç—å –±–∞—à–Ω—é
                    unit.y += unit.speed;
                    unit.el.style.bottom = unit.y + 'px';
                } else {
                    // –ê—Ç–∞–∫–∞ –±–∞—à–Ω–∏
                    const now = Date.now();
                    if (now - unit.lastAttackTime > 1000) { // –ê—Ç–∞–∫–∞ —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É
                        enemyTowerHP -= unit.dmg;
                        unit.lastAttackTime = now;
                        updateArenaUI();
                        if (enemyTowerHP <= 0) {
                            endGame("win");
                            return;
                        }
