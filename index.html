<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mana & Steel: Clan & PvP Foundation</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc;
            --accent: #38bdf8; --gold: #f59e0b; --danger: #ef4444; --success: #10b981;
        }
        .light-theme { --bg: #f1f5f9; --card-bg: #ffffff; --text: #0f172a; --accent: #0284c7; }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Inter', sans-serif; margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh; transition: 0.3s;
        }

        .nav-bar {
            display: flex; justify-content: space-around; background: var(--card-bg);
            padding: 10px 0; border-top: 1px solid rgba(255,255,255,0.1);
            position: fixed; bottom: 0; width: 100%; z-index: 100;
        }
        .nav-item { font-size: 10px; cursor: pointer; opacity: 0.6; text-align: center; flex: 1; }
        .nav-item.active { opacity: 1; color: var(--accent); font-weight: bold; }

        .screen { display: none; padding: 15px; padding-bottom: 90px; overflow-y: auto; flex: 1; }
        .screen.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; }
        
        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ HP */
        .hp-wrapper { width: 100%; background: #334155; height: 20px; border-radius: 10px; overflow: hidden; margin: 10px 0; border: 1px solid #475569; position: relative; }
        #hp-fill { height: 100%; background: linear-gradient(90deg, #ef4444, #f87171); transition: width 0.2s ease; width: 100%; }
        #hp-text { position: absolute; width: 100%; text-align: center; font-size: 11px; line-height: 20px; font-weight: bold; color: white; text-shadow: 1px 1px 2px black; }

        input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #475569; background: #0f172a; color: white; box-sizing: border-box; margin-bottom: 8px; }
        
        .chat-box { height: 250px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; }
        .msg { font-size: 13px; padding: 5px 10px; border-radius: 8px; background: #334155; max-width: 90%; }
        .msg b { color: var(--accent); font-size: 11px; }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background: var(--success); }
        .offline { background: #64748b; }
        .req-card { border: 1px solid var(--accent); background: rgba(56, 189, 248, 0.1); }
    </style>
</head>
<body>

    <div id="screen-battle" class="screen active">
        <div class="card" style="text-align: center;">
            <div style="display: flex; justify-content: space-between; font-weight: bold;">
                <span style="color: var(--accent)">LVL: <span id="p-lvl">1</span></span>
                <span style="color: var(--gold)">üí∞ <span id="p-gold">0</span></span>
            </div>
            <h3 id="m-name" style="margin: 15px 0 5px 0;">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
            <div class="hp-wrapper">
                <div id="hp-fill"></div>
                <div id="hp-text">10 / 10 HP</div>
            </div>
            <div id="monster-target" onclick="doAttack()" style="font-size: 90px; margin: 20px 0; cursor: pointer; display: inline-block;">üëæ</div>
            <div id="active-weapon" style="font-size: 13px; color: var(--success);">üëä –ö—É–ª–∞–∫–∏</div>
        </div>
    </div>

    <div id="screen-chat" class="screen">
        <h3>üí¨ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</h3>
        <div id="chat-box" class="chat-box"></div>
        <div style="display: flex; gap: 5px;">
            <input type="text" id="msg-input" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button class="btn" style="width: 60px;" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <div id="screen-inventory" class="screen">
        <h3>üéí –ú–∞–≥–∞–∑–∏–Ω & –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
        <div class="card" id="shop-list"></div>
        <div class="card" id="inventory-list"></div>
    </div>

    <div id="screen-friends" class="screen">
        <h3>üë• –î—Ä—É–∑—å—è & –ó–∞–ø—Ä–æ—Å—ã</h3>
        <div class="card">
            <input type="text" id="friend-id-input" placeholder="ID –∏–≥—Ä–æ–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è">
            <button class="btn" onclick="sendFriendRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>
        <div id="pending-requests"></div>
        <div class="card" id="friends-list">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</div>
        
        <h3>üèÜ –¢–æ–ø-10 –ò–≥—Ä–æ–∫–æ–≤</h3>
        <div class="card" id="leaderboard-list"></div>
    </div>

    <div id="screen-profile" class="screen">
        <h3>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h3>
        <div class="card">
            <p>ID: <span id="my-id-display" style="font-family: monospace; color: var(--accent)">...</span></p>
            <input type="text" id="in-name" maxlength="15">
            <button class="btn" onclick="updateNick()">–°–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>
        </div>
        <div class="card">
            <button class="btn" id="daily-btn" style="background: var(--gold);" onclick="claimDaily()">üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å</button>
        </div>
        <div class="card"><button class="btn" style="background:#64748b" onclick="toggleTheme()">–¢–µ–º–∞ üåó</button></div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="showScreen('battle')">‚öîÔ∏è<br>–ë–∏—Ç–≤–∞</div>
        <div class="nav-item" onclick="showScreen('chat')">üí¨<br>–ß–∞—Ç</div>
        <div class="nav-item" onclick="showScreen('inventory')">üéí<br>–ò–Ω–≤–µ–Ω—Ç.</div>
        <div class="nav-item" onclick="showScreen('friends')">üë•<br>–î—Ä—É–∑—å—è</div>
        <div class="nav-item" onclick="showScreen('profile')">üë§<br>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp, arrayUnion, arrayRemove, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCyZxBg-j_XKkvaqoKxi62uFY73kDkVWk4",
            authDomain: "manasteel-bf5f7.firebaseapp.com",
            projectId: "manasteel-bf5f7",
            storageBucket: "manasteel-bf5f7.firebasestorage.app",
            messagingSenderId: "120074826718",
            appId: "1:120074826718:web:9b289a1d28aceda479634f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        const ITEMS_DB = {
            'w1': { n: '–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –º–µ—á', d: 5, p: 150 },
            'w2': { n: '–°—Ç–∞–ª—å–Ω–æ–π –º–µ—á', d: 15, p: 600 },
            'w3': { n: '–ú–µ—á –î—Ä–∞–∫–æ–Ω–∞', d: 50, p: 2500 },
            'bot': { n: 'ü§ñ –ê–≤—Ç–æ-–∫–ª–∏–∫–µ—Ä', d: 0, p: 10000 }
        };

        let p = { name: '–ì–µ—Ä–æ–π', level: 1, gold: 0, inventory: [], equipped: null, hasBot: false, lastDaily: 0, friends: [], lastSeen: Date.now() };
        let m = { hp: 10, max: 10, lvl: 1 };
        const uid = String(tg.initDataUnsafe.user?.id || "dev_test");

        async function init() {
            const snap = await getDoc(doc(db, "players", uid));
            if (snap.exists()) p = { ...p, ...snap.data() };
            else await setDoc(doc(db, "players", uid), p);
            
            document.getElementById('my-id-display').innerText = uid;
            updateUI(); renderShop(); renderInventory();
            listenToChat(); listenToRequests();
            setInterval(updateStatus, 60000); // Online heartbeat
            loadTop();
        }

        window.showScreen = (name) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('screen-' + name).classList.add('active');
            event.currentTarget.classList.add('active');
            if(name === 'friends') { loadFriends(); loadTop(); }
        };

        // –ë–û–ô
        window.doAttack = (isAuto = false) => {
            let dmg = 2 + (p.level * 2) + (p.equipped ? ITEMS_DB[p.equipped].d : 0);
            m.hp -= dmg;
            if(!isAuto) tg.HapticFeedback.impactOccurred('light');
            if (m.hp <= 0) {
                p.gold += 10 * m.lvl;
                if (Math.random() > 0.8) p.level++;
                m.lvl++; m.max = 10 + (m.lvl * 12); m.hp = m.max;
                save();
            }
            updateUI();
        };

        // –î–†–£–ó–¨–Ø –ò –ó–ê–Ø–í–ö–ò
        window.sendFriendRequest = async () => {
            const targetId = document.getElementById('friend-id-input').value.trim();
            if(!targetId || targetId === uid) return;
            await addDoc(collection(db, "friendRequests"), {
                from: uid, fromName: p.name, to: targetId, status: 'pending', createdAt: serverTimestamp()
            });
            alert("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!");
            document.getElementById('friend-id-input').value = "";
        };

        function listenToRequests() {
            const q = query(collection(db, "friendRequests"), where("to", "==", uid), where("status", "==", "pending"));
            onSnapshot(q, (snap) => {
                const area = document.getElementById('pending-requests');
                area.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    area.innerHTML += `<div class="card req-card">
                        –ó–∞—è–≤–∫–∞ –æ—Ç <b>${data.fromName}</b> 
                        <button class="btn" style="background:var(--success); margin-top:5px;" onclick="acceptFriend('${data.from}', '${d.id}')">–ü—Ä–∏–Ω—è—Ç—å</button>
                    </div>`;
                });
            });
        }

        window.acceptFriend = async (fId, reqId) => {
            await updateDoc(doc(db, "players", uid), { friends: arrayUnion(fId) });
            await updateDoc(doc(db, "players", fId), { friends: arrayUnion(uid) });
            await updateDoc(doc(db, "friendRequests", reqId), { status: 'accepted' });
            p.friends.push(fId);
            loadFriends();
        };

        async function loadFriends() {
            const list = document.getElementById('friends-list');
            if (p.friends.length === 0) return list.innerHTML = "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π";
            let html = "";
            for (let fId of p.friends) {
                const fSnap = await getDoc(doc(db, "players", fId));
                if (fSnap.exists()) {
                    const d = fSnap.data();
                    const isOnline = (Date.now() - (d.lastSeen || 0)) < 120000;
                    html += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span><span class="status-dot ${isOnline?'online':'offline'}"></span>${d.name} (LVL ${d.level})</span>
                        <small style="opacity:0.6">${fId}</small>
                    </div>`;
                }
            }
            list.innerHTML = html;
        }

        // –¢–û–ü
        async function loadTop() {
            const q = query(collection(db, "players"), orderBy("level", "desc"), limit(10));
            const snap = await getDocs(q);
            let html = ""; let i = 1;
            snap.forEach(d => {
                const data = d.data();
                html += `<div style="display:flex; justify-content:space-between; padding:4px 0;">
                    <span>${i++}. ${data.name}</span> <b>LVL ${data.level}</b>
                </div>`;
            });
            document.getElementById('leaderboard-list').innerHTML = html;
        }

        // –ß–ê–¢
        function listenToChat() {
            const q = query(collection(db, "messages"), orderBy("createdAt", "desc"), limit(30));
            onSnapshot(q, (snap) => {
                const chatBox = document.getElementById('chat-box');
                let html = ""; const msgs = [];
                snap.forEach(d => msgs.push(d.data()));
                msgs.reverse().forEach(d => {
                    html += `<div class="msg"><b>${d.sender}:</b> ${d.text}</div>`;
                });
                chatBox.innerHTML = html;
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        window.sendMessage = async () => {
            const inp = document.getElementById('msg-input');
            if(!inp.value.trim()) return;
            await addDoc(collection(db, "messages"), { sender: p.name, text: inp.value, createdAt: serverTimestamp() });
            inp.value = "";
        };

        // –°–ò–°–¢–ï–ú–ù–û–ï
        function save() { updateDoc(doc(db, "players", uid), p); }
        async function updateStatus() { p.lastSeen = Date.now(); await updateDoc(doc(db, "players", uid), { lastSeen: p.lastSeen }); }
        
        function updateUI() {
            document.getElementById('p-gold').innerText = Math.floor(p.gold);
            document.getElementById('p-lvl').innerText = p.level;
            document.getElementById('m-name').innerText = `–ú–æ–Ω—Å—Ç—Ä –£—Ä. ${m.lvl}`;
            document.getElementById('hp-fill').style.width = (m.hp/m.max*100) + "%";
            document.getElementById('hp-text').innerText = `${Math.max(0, m.hp)} / ${m.max} HP`;
            document.getElementById('active-weapon').innerText = p.equipped ? `üó° ${ITEMS_DB[p.equipped].n}` : "üëä –ö—É–ª–∞–∫–∏";
        }

        window.buyItem = (id) => {
            const item = ITEMS_DB[id];
            if (p.gold >= item.p) {
                if (id === 'bot') p.hasBot = true; else p.inventory.push(id);
                p.gold -= item.p; save(); updateUI(); renderShop(); renderInventory();
            }
        };

        window.renderShop = () => { /* –ª–æ–≥–∏–∫–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ */ };
        window.renderInventory = () => { /* –ª–æ–≥–∏–∫–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ */ };
        window.updateNick = () => { let n = document.getElementById('in-name').value.trim(); if(n){ p.name = n; save(); alert("–ù–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω!"); } };
        window.toggleTheme = () => document.body.classList.toggle('light-theme');
        
        init();
    </script>
</body>
</html>
